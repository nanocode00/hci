{% extends "base.html" %}

{% block extra_css %}
<style>
  .text-buy {
    color: red !important;
  }

  .text-sell {
    color: blue !important;
  }
</style>
{% endblock %}

{% block content %}
<!-- data -->
<section class="section pb-0">
  <div class="container">
    <div class="row">
      <div class="col-12">
        {% if q and reports %}
        <h2 class="section-title text-primary">
          {{ reports[0].stock.stock_name }}
          <small class="text-muted font-weight-light" style="font-size: 0.6em;">{{ reports[0].stock.stock_code
            }}</small>
          {% if reports[0].stock.current_price %}
          <span class="text-dark" style="font-size: 0.6em; margin-left: 10px;">{{
            "{:,}".format(reports[0].stock.current_price) }} KRW</span>
          {% endif %}
        </h2>
        {% else %}
        <h2 class="section-title text-primary">Company</h2>
        {% endif %}
        <!-- accordion -->
        <!-- 1. 테이블 전체에 ID를 줍니다 (그룹핑용) -->
        <table class="table table-hover" id="accordionTable">
          <thead>
            <tr>

              <th scope="col">Date</th>
              <th scope="col">Analyst</th>
              <th scope="col">Position</th>
              <th scope="col">Target Price</th>
              <th scope="col">PL</th>
              <th scope="col">Expert Firm</th>
              <th scope="col">Inc Info</th>
              <th scope="col">Article</th>
            </tr>
          </thead>

          <!-- 여기서부터 테이블의 행입니다.-->
          <!-- data-toggle="collapse": 클릭 기능 활성화 -->
          <!-- data-target="#detail1": 클릭 시 열릴 상세 내용의 ID 연결 -->
          <!-- 각 행의 data-target="#detailk" 에서 k는 행을 구분하기 위해 행마다 1씩 증가해야합니다.-->
          <tbody>
            {% for report in reports %}
            <!-- [Row {{ loop.index }}] -->
            {% set text_class = '' %}
            {% if report.rating_code == 'Buy' %}
            {% set text_class = 'text-buy' %}
            {% elif report.rating_code == 'Sell' %}
            {% set text_class = 'text-sell' %}
            {% endif %}
            <tr data-toggle="collapse" data-target="#detail{{ loop.index }}" style="cursor:pointer;">
              <td>{{ report.written_date }}</td>
              <td>{{ report.author.name if report.author else '-' }}</td>
              <td class="{{ text_class }}">{{ report.rating_code }}</td>
              <td class="{{ text_class }}">{{ "{:,}".format(report.fair_price) if report.fair_price else '-' }}</td>
              <td>
                {% if report.stock.current_price and report.fair_price %}
                {% set pl = ((report.fair_price - report.stock.current_price) / report.stock.current_price) * 100 %}
                {% set pl_class = 'text-sell' if pl < 0 else 'text-buy' %} <span class="{{ pl_class }}">{{
                  "{:.2f}%".format(pl) }}</span>
                  {% else %}
                  -
                  {% endif %}
              </td>
              <td>{{ report.broker.name if report.broker else '-' }}</td>
              <td>
                {% if report.stock.company_info_url %}
                <a href="{{ report.stock.company_info_url }}" target="_blank">Link</a>
                {% else %}
                -
                {% endif %}
              </td>
              <td>
                {% if report.attachment_url %}
                <a href="{{ report.attachment_url }}" target="_blank">Link</a>
                {% else %}
                -
                {% endif %}
              </td>
            </tr>
            <!-- [Detail Row {{ loop.index }}] -->
            <tr>
              <td colspan="8" class="p-0 border-0">
                <div id="detail{{ loop.index }}" class="collapse" data-parent="#accordionTable">
                  <div class="p-4 bg-light">

                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="myTabRow{{ loop.index }}" role="tablist">
                      <li class="nav-item">
                        <a class="nav-link active" id="tab-r{{ loop.index }}-sum" data-toggle="tab"
                          href="#content-r{{ loop.index }}-sum" role="tab" aria-selected="true">
                          Summary
                        </a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" id="tab-r{{ loop.index }}-novice" data-toggle="tab"
                          href="#content-r{{ loop.index }}-novice" role="tab" aria-selected="false">
                          Novice
                        </a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" id="tab-r{{ loop.index }}-expert" data-toggle="tab"
                          href="#content-r{{ loop.index }}-expert" role="tab" aria-selected="false">
                          Expert
                        </a>
                      </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content bg-white border border-top-0 p-3" id="myTabContentRow{{ loop.index }}">

                      <!-- Summary Tab -->
                      <div class="tab-pane fade show active" id="content-r{{ loop.index }}-sum" role="tabpanel">
                      </div>

                      <!-- Novice Tab -->
                      <div class="tab-pane fade" id="content-r{{ loop.index }}-novice" role="tabpanel">
                      </div>

                      <!-- Expert Tab -->
                      <div class="tab-pane fade" id="content-r{{ loop.index }}-expert" role="tabpanel">
                      </div>

                    </div>

                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
<!-- /data -->
{% endblock %}